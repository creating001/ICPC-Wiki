# SG函数

> 板子题网址: https://www.acwing.com/problem/content/895
>
> 板子题网址: https://www.acwing.com/problem/content/896
>
> 板子题网址: https://www.luogu.com.cn/problem/AT_agc017_d

## Mex运算

对于一个集合 $S$ ，其 $Mex$ 运算的结果为 $S$ 中不属于 $S$ 的最小非负整数。

$Mex(S)=min\{i|i\in N,i\notin S\}$

## SG函数

对于一个局面 $S$ ，其 $SG$ 函数的结果为 $S$ 的所有后继局面的 $SG$ 函数值的 $Mex$ 运算的结果。
其中终点的 $SG$ 函数值为 $0$ 。

$SG(S)=Mex\{SG(T)|T\in Next(S)\}$

## SG定理

有向图游戏的某个局面必胜，当且仅当该局面对应节点的 $SG$ 函数值大于0。
有向图游戏的某个局面必败，当且仅当该局面对应节点的 $SG$ 函数值等于0。

## 有向图游戏的和

设 $G1, G2, \dots, Gm$ 是 $m$ 个有向图游戏。定义有向图游戏 $G$ ，它的行动规则是任选某个有向图游戏Gi，并在Gi上行动一步。G被称为有向图游戏 $G1, G2, \dots, Gm$ 的和。

有向图游戏的和的 $SG$ 函数值等于它包含的各个子游戏 $SG$ 函数值的异或和，即：

$SG(G) = SG(G1) \oplus SG(G2) \oplus \dots \oplus SG(Gm)$

## SG函数的计算

```cpp
inline int sg(int x) {
    if (~f[x]) return f[x];
    // 记忆化搜索
    return f[x] = ans;
}
```

## 树上SG函数

> 板子题网址: https://www.luogu.com.cn/problem/AT_agc017_d

$SG(X) = (SG(X_1)+1) \oplus (SG(X_2)+1) \oplus \cdots \oplus (SG(X_k)+1)$

证明:

根据 Nim 游戏的结论，我只能猜测整棵树的 SG 值应该等于每棵子树的 SG 值加上 1 后的异或和。

对着样例验证发现没错，交上去 AC 了。那么这个结论要如何证明呢？

我们注意到，如果有 k 棵子树，那么我们可以把根节点复制 k 份，每个根节点只下接一棵子树。

这样就分成了独立的 k 个游戏，而每个游戏中，根节点只有一棵子树。显然原树的 SG 值等于这些子游戏的 SG 值的异或和。

但是对于根节点只有一个孩子的游戏，它的 SG 值又如何求出呢——已经无法分解成更小的游戏了。

但我们可以证明这样一个结论：对于根节点只有一个孩子的游戏，其 SG 值为其子树的 SG 值加上 1 。

我们可以这样证明：如果直接断开了根与其子树相连的边，则下一状态的 SG 值为 0。

否则，也就是断开了子树内的边，此时仍然满足根节点只有一个孩子，而且问题规模更小。

结合数学归纳法，我们可以证明原树可以转移到每个子树能转移到的状态的 SG 值加 1 的状态，从而证明此结论。

所以只要对这棵树做一次 DFS 即可，某棵树的 SG 值为其所有子树的 SG 值加 1 后的异或和。
